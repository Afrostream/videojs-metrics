<<<<<<< HEAD
/**
 * videojs-metrics
 * @version 1.2.0
 * @copyright 2016 Afrostream, Inc.
 * @license Apache-2.0
 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.videojsMetrics=e()}}(function(){return function e(t,n,o){function r(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var f=n[s]={exports:{}};t[s][0].call(f.exports,function(e){var n=t[s][1][e];return r(n?n:e)},f,f.exports,e,t,n,o)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r}({1:[function(e,t,n){(function(t){"use strict";function n(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t["default"]=e,t}function o(e){return e&&e.__esModule?e:{"default":e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),a=function(e,t,n){for(var o=!0;o;){var r=e,i=t,s=n;o=!1,null===r&&(r=Function.prototype);var a=Object.getOwnPropertyDescriptor(r,i);if(void 0!==a){if("value"in a)return a.value;var u=a.get;if(void 0===u)return;return u.call(s)}var d=Object.getPrototypeOf(r);if(null===d)return;e=d,t=i,n=s,o=!0,a=d=void 0}},u="undefined"!=typeof window?window.videojs:"undefined"!=typeof t?t.videojs:null,d=o(u),f=e("xhr"),c=o(f),l=e("global/window"),p=o(l),h=e("global/document"),w=o(h),y=e("./utils.js"),v=n(y),b=d["default"].getComponent("Component"),m=d["default"].getComponent("Flash"),g=function(e){function t(e,n){r(this,t),a(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,n);var o=this.player().manifestUrl||this.player().currentSrc();this.browserInfo=v.getBrowser(),this.pathUrl=o.match(t.URL_MATCH)||["undefined","undefined"],this.setupTriggers()}return i(t,e),s(t,[{key:"dispose",value:function(){this.clearInterval(this.intervalPing),this.setupTriggers("off")}},{key:"eventHandler",value:function(e){var n={type:e.type},o=!1;switch(n.type){case"error":var r=this.player().error();r=r||{code:-1,message:"cant get error message"},n.number=r.code,n.message=r.message;break;case"dispose":case"ended":n.type===this.oldType&&(o=!0),n.type="stop";break;case"loadstart":o=!0;break;case"firstplay":n.type="start",this.intervalPing=this.setInterval(this.onPing,t.INTERVAL_PING);break;case"waiting":n.type="buffering";break;case"bandwidthIncrease":case"bandwidthDecrease":}this.oldType=n.type,o||this.notify(n)}},{key:"onPing",value:function(){this.player().trigger("ping")}},{key:"setupTriggers",value:function(e){var t=e||"on",n=this.options_.trackEvents,o=this.player(),r=n.length-1;for(r;r>=0;r--){var i=t;"firstplay"===n[r]&&"on"===t&&(i="one"),o[i](n[r],d["default"].bind(this,this.eventHandler))}}},{key:"pick",value:function(e,t,n){var o={};return"string"==typeof t&&(t=[t]),Object.keys(e).forEach(function(n){t.indexOf(n)>-1&&(o[n]=e[n])},n),o}},{key:"getRequiredKeys",value:function(e){return t.BASE_KEYS.concat(t.REQUIRED_KEY[e]||[])}},{key:"notify",value:function(e){var n=this.player(),o=p["default"].innerWidth||w["default"].documentElement.clientWidth||w["default"].body.clientWidth,r=p["default"].innerHeight||w["default"].documentElement.clientHeight||w["default"].body.clientHeight;e.user_id=this.options_.user_id,e.fqdn=this.pathUrl[1],e.os=this.browserInfo.os,e.os_version=this.browserInfo.osVersion.toString(),e.web_browser=this.browserInfo.browser.toString(),e.web_browser_version=this.browserInfo.version?this.browserInfo.version.toString():"",e.resolution_size=o+"x"+r,e.flash_version=m.version().join(","),e.html5_video=n.techName_?"FLash"!==n.techName_||"DashAs"!==n.techName_:"undefined",e.relative_url=this.pathUrl[2],e.timeout=!1,e.frames_dropped=0;try{var i=n.techGet_("getPlaybackStatistics");this.metrics_=d["default"].mergeOptions(this.metrics_,i),e.video_bitrate=this.metrics_.video.bandwidth>0?Math.max(-1,Math.round(this.metrics_.video.bandwidth/1e3)):-1,e.audio_bitrate=this.metrics_.audio.bandwidth>0?Math.max(-1,Math.round(this.metrics_.audio.bandwidth/1e3)):-1,e.chunks_from_cdn=this.metrics_.p2pweb.chunksFromCDN,e.chunks_from_p2p=this.metrics_.p2pweb.chunksFromP2P,e.startup_time=this.metrics_.p2pweb.startupTime;var s=this.pick(e,this.getRequiredKeys(e.type)),a={json:s,uri:this.options_.url,method:"POST",headers:{"Content-Type":"application/json"}};t.xhr(a,function(e){if(e)throw new Error(e.message)})}catch(u){d["default"].log(u)}}}]),t}(b);g.REQUIRED_KEY={bandwidthIncrease:["video_bitrate","audio_bitrate"],bandwidthDecrease:["video_bitrate","audio_bitrate"],ping:["chunks_from_cdn","chunks_from_p2p"],buffering:[],error:["number","message"],start:["video_bitrate","audio_bitrate","os","os_version","web_browser","web_browser_version","resolution_size","flash_version","html5_video","relative_url"],stop:["timeout","frames_dropped"]},g.URL_MATCH=/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/,g.prototype.pathUrl="",g.prototype.oldType=null,g.prototype.intervalPing=0,g.prototype.browserInfo={},g.prototype.options_={option:!0,user_id:666,method:"POST",responseType:"json",timeout:1e3,url:"//stats.afrostream.tv/api/v1/events",trackEvents:["loadstart","ping","firstplay","ended","dispose","waiting","error","bandwidthIncrease","bandwidthDecrease"]},g.INTERVAL_PING=6e4,g.BASE_KEYS=["user_id","type","fqdn"],g.METRICS_DATA={bandwidth:-1,bitrateIndex:0,pendingIndex:"",numBitrates:0,bufferLength:0,droppedFrames:0,movingLatency:0,movingDownload:0,movingRatio:0,requestsQueue:0},g.prototype.metrics_={video:d["default"].mergeOptions({},g.METRICS_DATA),audio:d["default"].mergeOptions({},g.METRICS_DATA)},g.xhr=c["default"],b.registerComponent("Metrics",g),d["default"].options.children.metrics={}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./utils.js":2,"global/document":4,"global/window":5,xhr:6}],2:[function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{"default":e}}function r(){var e={},t="",n="",o="",r="",i=void 0,s=void 0,a=void 0,u=void 0;return i=function(){var e=navigator.userAgent.toLowerCase(),i=/(ie|firefox|chrome|safari|opera)(?:.*version)?(?:[ \/])?([\w.]+)/.exec(e),s=/(mac|win|linux|freebsd|mobile|iphone|ipod|ipad|android|blackberry|j2me|webtv)/.exec(e);e.match(/trident\/7\./)?i&&i.length>2&&(t=i[1],n=i[2]):(t="ie",n=11),s&&s.length>1&&(o=s[1]),r=navigator.oscpu||navigator.appName},s=function(){e.browser=t,e.version=parseInt(n,10)||"",e.os=o,e.osVersion=r},a=function(){"mac"===o&&(o="osx")},u=function(){"safari"===o&&(n=n.substring(0,1))},i(),a(),u(),s(),e}Object.defineProperty(n,"__esModule",{value:!0}),n.getBrowser=r;var i=e("global/document"),s=(o(i),e("global/window"));o(s)},{"global/document":4,"global/window":5}],3:[function(e,t,n){},{}],4:[function(e,t,n){(function(n){var o="undefined"!=typeof n?n:"undefined"!=typeof window?window:{},r=e("min-document");if("undefined"!=typeof document)t.exports=document;else{var i=o["__GLOBAL_DOCUMENT_CACHE@4"];i||(i=o["__GLOBAL_DOCUMENT_CACHE@4"]=r),t.exports=i}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"min-document":3}],5:[function(e,t,n){(function(e){"undefined"!=typeof window?t.exports=window:"undefined"!=typeof e?t.exports=e:"undefined"!=typeof self?t.exports=self:t.exports={}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(e,t,n){"use strict";function o(e,t){for(var n=0;n<e.length;n++)t(e[n])}function r(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function i(e,t,n){var o=e;return c(t)?(n=t,"string"==typeof e&&(o={uri:e})):o=p(t,{uri:e}),o.callback=n,o}function s(e,t,n){return t=i(e,t,n),a(t)}function a(e){function t(){4===d.readyState&&i()}function n(){var e=void 0;if(d.response?e=d.response:"text"!==d.responseType&&d.responseType||(e=d.responseText||d.responseXML),g)try{e=JSON.parse(e)}catch(t){}return e}function o(e){clearTimeout(h),e instanceof Error||(e=new Error(""+(e||"Unknown XMLHttpRequest Error"))),e.statusCode=0,a(e,u)}function i(){if(!p){var t;clearTimeout(h),t=e.useXDR&&void 0===d.status?200:1223===d.status?204:d.status;var o=u,r=null;0!==t?(o={body:n(),statusCode:t,method:y,headers:{},url:w,rawRequest:d},d.getAllResponseHeaders&&(o.headers=l(d.getAllResponseHeaders()))):r=new Error("Internal XMLHttpRequest Error"),a(r,o,o.body)}}var a=e.callback;if("undefined"==typeof a)throw new Error("callback argument missing");a=f(a);var u={body:void 0,headers:{},statusCode:0,method:y,url:w,rawRequest:d},d=e.xhr||null;d||(d=e.cors||e.useXDR?new s.XDomainRequest:new s.XMLHttpRequest);var c,p,h,w=d.url=e.uri||e.url,y=d.method=e.method||"GET",v=e.body||e.data||null,b=d.headers=e.headers||{},m=!!e.sync,g=!1;if("json"in e&&(g=!0,b.accept||b.Accept||(b.Accept="application/json"),"GET"!==y&&"HEAD"!==y&&(b["content-type"]||b["Content-Type"]||(b["Content-Type"]="application/json"),v=JSON.stringify(e.json))),d.onreadystatechange=t,d.onload=i,d.onerror=o,d.onprogress=function(){},d.ontimeout=o,d.open(y,w,!m,e.username,e.password),m||(d.withCredentials=!!e.withCredentials),!m&&e.timeout>0&&(h=setTimeout(function(){p=!0,d.abort("timeout");var e=new Error("XMLHttpRequest timeout");e.code="ETIMEDOUT",o(e)},e.timeout)),d.setRequestHeader)for(c in b)b.hasOwnProperty(c)&&d.setRequestHeader(c,b[c]);else if(e.headers&&!r(e.headers))throw new Error("Headers cannot be set on an XDomainRequest object");return"responseType"in e&&(d.responseType=e.responseType),"beforeSend"in e&&"function"==typeof e.beforeSend&&e.beforeSend(d),d.send(v),d}function u(){}var d=e("global/window"),f=e("once"),c=e("is-function"),l=e("parse-headers"),p=e("xtend");t.exports=s,s.XMLHttpRequest=d.XMLHttpRequest||u,s.XDomainRequest="withCredentials"in new s.XMLHttpRequest?s.XMLHttpRequest:d.XDomainRequest,o(["get","put","post","patch","head","delete"],function(e){s["delete"===e?"del":e]=function(t,n,o){return n=i(t,n,o),n.method=e.toUpperCase(),a(n)}})},{"global/window":5,"is-function":7,once:8,"parse-headers":11,xtend:12}],7:[function(e,t,n){function o(e){var t=r.call(e);return"[object Function]"===t||"function"==typeof e&&"[object RegExp]"!==t||"undefined"!=typeof window&&(e===window.setTimeout||e===window.alert||e===window.confirm||e===window.prompt)}t.exports=o;var r=Object.prototype.toString},{}],8:[function(e,t,n){function o(e){var t=!1;return function(){return t?void 0:(t=!0,e.apply(this,arguments))}}t.exports=o,o.proto=o(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return o(this)},configurable:!0})})},{}],9:[function(e,t,n){function o(e,t,n){if(!a(t))throw new TypeError("iterator must be a function");arguments.length<3&&(n=this),"[object Array]"===u.call(e)?r(e,t,n):"string"==typeof e?i(e,t,n):s(e,t,n)}function r(e,t,n){for(var o=0,r=e.length;r>o;o++)d.call(e,o)&&t.call(n,e[o],o,e)}function i(e,t,n){for(var o=0,r=e.length;r>o;o++)t.call(n,e.charAt(o),o,e)}function s(e,t,n){for(var o in e)d.call(e,o)&&t.call(n,e[o],o,e)}var a=e("is-function");t.exports=o;var u=Object.prototype.toString,d=Object.prototype.hasOwnProperty},{"is-function":7}],10:[function(e,t,n){function o(e){return e.replace(/^\s*|\s*$/g,"")}n=t.exports=o,n.left=function(e){return e.replace(/^\s*/,"")},n.right=function(e){return e.replace(/\s*$/,"")}},{}],11:[function(e,t,n){var o=e("trim"),r=e("for-each"),i=function(e){return"[object Array]"===Object.prototype.toString.call(e)};t.exports=function(e){if(!e)return{};var t={};return r(o(e).split("\n"),function(e){var n=e.indexOf(":"),r=o(e.slice(0,n)).toLowerCase(),s=o(e.slice(n+1));"undefined"==typeof t[r]?t[r]=s:i(t[r])?t[r].push(s):t[r]=[t[r],s]}),t}},{"for-each":9,trim:10}],12:[function(e,t,n){function o(){for(var e={},t=0;t<arguments.length;t++){var n=arguments[t];for(var o in n)r.call(n,o)&&(e[o]=n[o])}return e}t.exports=o;var r=Object.prototype.hasOwnProperty},{}],13:[function(e,t,n){(function(o){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var i="undefined"!=typeof window?window.videojs:"undefined"!=typeof o?o.videojs:null,s=r(i),a=e("./metrics"),u=r(a),d=function(e){(0,u["default"])(this,e)};s["default"].plugin("metrics",d),n["default"]=d,t.exports=n["default"]}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./metrics":1}]},{},[13])(13)});
=======
/*! videojs-metrics - v0.0.0 - 2016-03-04
* Copyright (c) 2016 benjipott; Licensed Apache-2.0 */
!function(a,b){"use strict";b.Metrics=b.Component.extend({init:function(a,c){b.Component.call(this,a,c),this.browserInfo=b.Metrics.getBrowser();var d=this.player().manifestUrl||this.player().currentSrc();this.pathUrl=d.match(b.Metrics.URL_MATCH)||["undefined","undefined"],this.setupTriggers()}}),b.Metrics.prototype.options_={option:!0,user_id:666,method:"POST",responseType:"json",timeout:1e3,url:"//stats.afrostream.tv/api/v1/events",trackEvents:["loadstart","ping","firstplay","ended","dispose","waiting","error","bandwidthIncrease","bandwidthDecrease"]},b.Metrics.getBrowser=function(){var a,b,c,d,e={},f="",g="",h="",i="";return a=function(){var a=navigator.userAgent.toLowerCase(),b=/(ie|firefox|chrome|safari|opera)(?:.*version)?(?:[ \/])?([\w.]+)/.exec(a),c=/(mac|win|linux|freebsd|mobile|iphone|ipod|ipad|android|blackberry|j2me|webtv)/.exec(a);a.match(/trident\/7\./)?(f="ie",g=11):b&&b.length>2&&(f=b[1],g=b[2]),c&&c.length>1&&(h=c[1]),i=navigator.oscpu||navigator.appName},b=function(){e.browser=f,e.version=parseInt(g,10)||"",e.os=h,e.osVersion=i},c=function(){"mac"===h&&(h="osx")},d=function(){"safari"===h&&(g=g.substring(0,1))},a(),c(),d(),b(),e},b.Metrics.INTERVAL_PING=6e4,b.Metrics.BASE_KEYS=["user_id","type","fqdn"],b.Metrics.METRICS_DATA={bandwidth:-1,bitrateIndex:0,pendingIndex:"",numBitrates:0,bufferLength:0,droppedFrames:0,movingLatency:0,movingDownload:0,movingRatio:0,requestsQueue:0},b.Metrics.prototype.metrics_={video:b.util.mergeOptions({},b.Metrics.METRICS_DATA),audio:b.util.mergeOptions({},b.Metrics.METRICS_DATA)},b.Metrics.REQUIRED_KEY={bandwidthIncrease:["video_bitrate","audio_bitrate"],bandwidthDecrease:["video_bitrate","audio_bitrate"],ping:["chunks_from_cdn","chunks_from_p2p"],buffering:[],error:["number","message"],start:["video_bitrate","audio_bitrate","os","os_version","web_browser","web_browser_version","resolution_size","flash_version","html5_video","relative_url"],stop:["timeout","frames_dropped"]},b.Metrics.URL_MATCH=/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/,b.Metrics.prototype.pathUrl="",b.Metrics.prototype.oldType=null,b.Metrics.prototype.intervalPing=0,b.Metrics.prototype.browserInfo={},b.Metrics.prototype.dispose=function(){this.clearInterval(this.intervalPing),this.setupTriggers("off")},b.Metrics.prototype.eventHandler=function(a){var c={type:a.type},d=!1;switch(c.type){case"error":var e=this.player().error();e=e||{code:-1,message:"cant get error message"},c.number=e.code,c.message=e.message;break;case"dispose":case"ended":c.type===this.oldType&&(d=!0),c.type="stop";break;case"loadstart":d=!0;break;case"firstplay":c.type="start",this.intervalPing=this.setInterval(this.onPing,b.Metrics.INTERVAL_PING);break;case"waiting":c.type="buffering";break;case"bandwidthIncrease":case"bandwidthDecrease":}this.oldType=c.type,d||this.notify(c)},b.Metrics.prototype.onPing=function(){this.player().trigger("ping")},b.Metrics.prototype.setupTriggers=function(a){for(var c=a||"on",d=this.options_.trackEvents,e=this.player(),f=d.length-1;f>=0;f--){var g=c;"firstplay"===d[f]&&"on"===c&&(g="one"),e[g](d[f],b.bind(this,this.eventHandler))}},b.Metrics.pick=function(a,b,c){var d={};return"string"==typeof b&&(b=[b]),Object.keys(a).forEach(function(c){b.indexOf(c)>-1&&(d[c]=a[c])},c),d},b.Metrics.prototype.getRequiredKeys=function(a){return b.Metrics.BASE_KEYS.concat(b.Metrics.REQUIRED_KEY[a]||[])},b.Metrics.prototype.notify=function(a){var c=this.player();a.user_id=this.options_.user_id,a.fqdn=this.pathUrl[1],a.os=this.browserInfo.os,a.os_version=this.browserInfo.osVersion.toString(),a.web_browser=this.browserInfo.browser.toString(),a.web_browser_version=this.browserInfo.version?this.browserInfo.version.toString():"",a.resolution_size=screen.width+"x"+screen.height,a.flash_version=b.Flash.version().join(","),a.html5_video=c.tech?"VIDEO"===c.tech.el().nodeName:"undefined",a.relative_url=this.pathUrl[2],a.timeout=!1,a.frames_dropped=0;try{var d=c.techGet("getPlaybackStatistics");this.metrics_=b.util.mergeOptions(this.metrics_,d),a.video_bitrate=this.metrics_.video.bandwidth>0?Math.max(-1,Math.round(this.metrics_.video.bandwidth/1e3)):-1,a.audio_bitrate=this.metrics_.audio.bandwidth>0?Math.max(-1,Math.round(this.metrics_.audio.bandwidth/1e3)):-1,a.chunks_from_cdn=this.metrics_.p2pweb.chunksFromCDN,a.chunks_from_p2p=this.metrics_.p2pweb.chunksFromP2P,a.startup_time=this.metrics_.p2pweb.startupTime,a=b.Metrics.pick(a,this.getRequiredKeys(a.type))}catch(e){b.log(e)}this.xhr(this.options_,a)},b.Metrics.prototype.xhr=function(c,d,e){var f,g,h={method:"GET",timeout:45e3};"function"!=typeof e&&(e=function(){}),"object"==typeof c&&(h=b.util.mergeOptions(h,c),c=h.url);var i=a.XMLHttpRequest;return"undefined"==typeof i&&(i=function(){try{return new a.ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new a.ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new a.ActiveXObject("Msxml2.XMLHTTP")}catch(d){}throw new Error("This browser does not support XMLHttpRequest.")}),f=new i,f.open(h.method,c),f.url=c,f.requestTime=(new Date).getTime(),f.setRequestHeader("Content-Type","application/json"),h.responseType&&(f.responseType=h.responseType),h.withCredentials&&(f.withCredentials=!0),h.timeout&&(g=a.setTimeout(function(){4!==f.readyState&&(f.timedout=!0,f.abort())},h.timeout)),f.onreadystatechange=function(){return 4===this.readyState?(a.clearTimeout(g),f.timedout?e.call(this,"timeout",c):this.status>=400||0===this.status?e.call(this,!0,c):(this.response&&(this.responseTime=(new Date).getTime(),this.roundTripTime=this.responseTime-this.requestTime,this.bytesReceived=this.response.byteLength||this.response.length,this.bandwidth=Math.floor(this.bytesReceived/this.roundTripTime*8*1e3)),e.call(this,!1,c))):void 0},f.send(JSON.stringify(d)),f},b.options.children.metrics={}}(window,window.videojs);
>>>>>>> master
