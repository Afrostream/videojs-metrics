/**
 * videojs-metrics
 * @version 1.2.0
 * @copyright 2016 Afrostream, Inc.
 * @license Apache-2.0
 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.videojsMetrics=e()}}(function(){return function e(t,n,o){function r(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var f=n[s]={exports:{}};t[s][0].call(f.exports,function(e){var n=t[s][1][e];return r(n?n:e)},f,f.exports,e,t,n,o)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r}({1:[function(e,t,n){(function(t){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),s=function(e,t,n){for(var o=!0;o;){var r=e,i=t,s=n;o=!1,null===r&&(r=Function.prototype);var a=Object.getOwnPropertyDescriptor(r,i);if(void 0!==a){if("value"in a)return a.value;var u=a.get;if(void 0===u)return;return u.call(s)}var d=Object.getPrototypeOf(r);if(null===d)return;e=d,t=i,n=s,o=!0,a=d=void 0}},a="undefined"!=typeof window?window.videojs:"undefined"!=typeof t?t.videojs:null,u=n(a),d=e("xhr"),f=n(d),c=e("global/window"),l=n(c),p=e("global/document"),h=n(p),y=u["default"].getComponent("Component"),w=function(e){function t(e,n){o(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,n);var r=this.player().manifestUrl||this.player().currentSrc();this.browserInfo=u["default"].Metrics.getBrowser(),this.pathUrl=r.match(u["default"].Metrics.URL_MATCH)||["undefined","undefined"],this.setupTriggers()}return r(t,e),i(t,[{key:"getBrowser",value:function(){var e={},t="",n="",o="",r="",i=void 0,s=void 0,a=void 0,u=void 0;return i=function(){var e=navigator.userAgent.toLowerCase(),i=/(ie|firefox|chrome|safari|opera)(?:.*version)?(?:[ \/])?([\w.]+)/.exec(e),s=/(mac|win|linux|freebsd|mobile|iphone|ipod|ipad|android|blackberry|j2me|webtv)/.exec(e);e.match(/trident\/7\./)?i&&i.length>2&&(t=i[1],n=i[2]):(t="ie",n=11),s&&s.length>1&&(o=s[1]),r=navigator.oscpu||navigator.appName},s=function(){e.browser=t,e.version=parseInt(n,10)||"",e.os=o,e.osVersion=r},a=function(){"mac"===o&&(o="osx")},u=function(){"safari"===o&&(n=n.substring(0,1))},i(),a(),u(),s(),e}},{key:"dispose",value:function(){this.clearInterval(this.intervalPing),this.setupTriggers("off")}},{key:"eventHandler",value:function(e){var t={type:e.type},n=!1;switch(t.type){case"error":var o=this.player().error();o=o||{code:-1,message:"cant get error message"},t.number=o.code,t.message=o.message;break;case"dispose":case"ended":t.type===this.oldType&&(n=!0),t.type="stop";break;case"loadstart":n=!0;break;case"firstplay":t.type="start",this.intervalPing=this.setInterval(this.onPing,u["default"].Metrics.INTERVAL_PING);break;case"waiting":t.type="buffering";break;case"bandwidthIncrease":case"bandwidthDecrease":}this.oldType=t.type,n||this.notify(t)}},{key:"onPing",value:function(){this.player().trigger("ping")}},{key:"setupTriggers",value:function(e){var t=e||"on",n=this.options_.trackEvents,o=this.player(),r=n.length-1;for(r;r>=0;r--){var i=t;"firstplay"===n[r]&&"on"===t&&(i="one"),o[i](n[r],u["default"].bind(this,this.eventHandler))}}},{key:"pick",value:function(e,t,n){var o={};return"string"==typeof t&&(t=[t]),Object.keys(e).forEach(function(n){t.indexOf(n)>-1&&(o[n]=e[n])},n),o}},{key:"getRequiredKeys",value:function(e){return u["default"].Metrics.BASE_KEYS.concat(u["default"].Metrics.REQUIRED_KEY[e]||[])}},{key:"notify",value:function(e){var t=this.player(),n=l["default"].innerWidth||h["default"].documentElement.clientWidth||h["default"].body.clientWidth,o=l["default"].innerHeight||h["default"].documentElement.clientHeight||h["default"].body.clientHeight;e.user_id=this.options().user_id,e.fqdn=this.pathUrl[1],e.os=this.browserInfo.os,e.os_version=this.browserInfo.osVersion.toString(),e.web_browser=this.browserInfo.browser.toString(),e.web_browser_version=this.browserInfo.version?this.browserInfo.version.toString():"",e.resolution_size=n+"x"+o,e.flash_version=u["default"].Flash.version().join(","),e.html5_video=t.tech?"VIDEO"===t.tech.el().nodeName:"undefined",e.relative_url=this.pathUrl[2],e.timeout=!1,e.frames_dropped=0;try{var r=t.techGet("getPlaybackStatistics");this.metrics_=u["default"].util.mergeOptions(this.metrics_,r),e.video_bitrate=this.metrics_.video.bandwidth>0?Math.max(-1,Math.round(this.metrics_.video.bandwidth/1e3)):-1,e.audio_bitrate=this.metrics_.audio.bandwidth>0?Math.max(-1,Math.round(this.metrics_.audio.bandwidth/1e3)):-1,e.chunks_from_cdn=this.metrics_.p2pweb.chunksFromCDN,e.chunks_from_p2p=this.metrics_.p2pweb.chunksFromP2P,e.startup_time=this.metrics_.p2pweb.startupTime;var i=u["default"].Metrics.pick(e,this.getRequiredKeys(e.type));this.xhr(this.options(),i)}catch(s){u["default"].log(s)}}}]),t}(y);w.REQUIRED_KEY={bandwidthIncrease:["video_bitrate","audio_bitrate"],bandwidthDecrease:["video_bitrate","audio_bitrate"],ping:["chunks_from_cdn","chunks_from_p2p"],buffering:[],error:["number","message"],start:["video_bitrate","audio_bitrate","os","os_version","web_browser","web_browser_version","resolution_size","flash_version","html5_video","relative_url"],stop:["timeout","frames_dropped"]},w.URL_MATCH=/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/,w.prototype.pathUrl="",w.prototype.oldType=null,w.prototype.intervalPing=0,w.prototype.browserInfo={},w.prototype.options_={option:!0,user_id:666,method:"POST",responseType:"json",timeout:1e3,url:"//stats.afrostream.tv/api/v1/events",trackEvents:["loadstart","ping","firstplay","ended","dispose","waiting","error","bandwidthIncrease","bandwidthDecrease"]},w.INTERVAL_PING=6e4,w.BASE_KEYS=["user_id","type","fqdn"],w.METRICS_DATA={bandwidth:-1,bitrateIndex:0,pendingIndex:"",numBitrates:0,bufferLength:0,droppedFrames:0,movingLatency:0,movingDownload:0,movingRatio:0,requestsQueue:0},w.prototype.metrics_={video:u["default"].mergeOptions({},w.METRICS_DATA),audio:u["default"].mergeOptions({},w.METRICS_DATA)},w.xhr=f["default"],y.registerComponent("Metrics",w),u["default"].options.children.metrics={}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"global/document":3,"global/window":4,xhr:5}],2:[function(e,t,n){},{}],3:[function(e,t,n){(function(n){var o="undefined"!=typeof n?n:"undefined"!=typeof window?window:{},r=e("min-document");if("undefined"!=typeof document)t.exports=document;else{var i=o["__GLOBAL_DOCUMENT_CACHE@4"];i||(i=o["__GLOBAL_DOCUMENT_CACHE@4"]=r),t.exports=i}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"min-document":2}],4:[function(e,t,n){(function(e){"undefined"!=typeof window?t.exports=window:"undefined"!=typeof e?t.exports=e:"undefined"!=typeof self?t.exports=self:t.exports={}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(e,t,n){"use strict";function o(e,t){for(var n=0;n<e.length;n++)t(e[n])}function r(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function i(e,t,n){var o=e;return c(t)?(n=t,"string"==typeof e&&(o={uri:e})):o=p(t,{uri:e}),o.callback=n,o}function s(e,t,n){return t=i(e,t,n),a(t)}function a(e){function t(){4===d.readyState&&i()}function n(){var e=void 0;if(d.response?e=d.response:"text"!==d.responseType&&d.responseType||(e=d.responseText||d.responseXML),g)try{e=JSON.parse(e)}catch(t){}return e}function o(e){clearTimeout(h),e instanceof Error||(e=new Error(""+(e||"Unknown XMLHttpRequest Error"))),e.statusCode=0,a(e,u)}function i(){if(!p){var t;clearTimeout(h),t=e.useXDR&&void 0===d.status?200:1223===d.status?204:d.status;var o=u,r=null;0!==t?(o={body:n(),statusCode:t,method:w,headers:{},url:y,rawRequest:d},d.getAllResponseHeaders&&(o.headers=l(d.getAllResponseHeaders()))):r=new Error("Internal XMLHttpRequest Error"),a(r,o,o.body)}}var a=e.callback;if("undefined"==typeof a)throw new Error("callback argument missing");a=f(a);var u={body:void 0,headers:{},statusCode:0,method:w,url:y,rawRequest:d},d=e.xhr||null;d||(d=e.cors||e.useXDR?new s.XDomainRequest:new s.XMLHttpRequest);var c,p,h,y=d.url=e.uri||e.url,w=d.method=e.method||"GET",v=e.body||e.data||null,b=d.headers=e.headers||{},m=!!e.sync,g=!1;if("json"in e&&(g=!0,b.accept||b.Accept||(b.Accept="application/json"),"GET"!==w&&"HEAD"!==w&&(b["content-type"]||b["Content-Type"]||(b["Content-Type"]="application/json"),v=JSON.stringify(e.json))),d.onreadystatechange=t,d.onload=i,d.onerror=o,d.onprogress=function(){},d.ontimeout=o,d.open(w,y,!m,e.username,e.password),m||(d.withCredentials=!!e.withCredentials),!m&&e.timeout>0&&(h=setTimeout(function(){p=!0,d.abort("timeout");var e=new Error("XMLHttpRequest timeout");e.code="ETIMEDOUT",o(e)},e.timeout)),d.setRequestHeader)for(c in b)b.hasOwnProperty(c)&&d.setRequestHeader(c,b[c]);else if(e.headers&&!r(e.headers))throw new Error("Headers cannot be set on an XDomainRequest object");return"responseType"in e&&(d.responseType=e.responseType),"beforeSend"in e&&"function"==typeof e.beforeSend&&e.beforeSend(d),d.send(v),d}function u(){}var d=e("global/window"),f=e("once"),c=e("is-function"),l=e("parse-headers"),p=e("xtend");t.exports=s,s.XMLHttpRequest=d.XMLHttpRequest||u,s.XDomainRequest="withCredentials"in new s.XMLHttpRequest?s.XMLHttpRequest:d.XDomainRequest,o(["get","put","post","patch","head","delete"],function(e){s["delete"===e?"del":e]=function(t,n,o){return n=i(t,n,o),n.method=e.toUpperCase(),a(n)}})},{"global/window":4,"is-function":6,once:7,"parse-headers":10,xtend:11}],6:[function(e,t,n){function o(e){var t=r.call(e);return"[object Function]"===t||"function"==typeof e&&"[object RegExp]"!==t||"undefined"!=typeof window&&(e===window.setTimeout||e===window.alert||e===window.confirm||e===window.prompt)}t.exports=o;var r=Object.prototype.toString},{}],7:[function(e,t,n){function o(e){var t=!1;return function(){return t?void 0:(t=!0,e.apply(this,arguments))}}t.exports=o,o.proto=o(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return o(this)},configurable:!0})})},{}],8:[function(e,t,n){function o(e,t,n){if(!a(t))throw new TypeError("iterator must be a function");arguments.length<3&&(n=this),"[object Array]"===u.call(e)?r(e,t,n):"string"==typeof e?i(e,t,n):s(e,t,n)}function r(e,t,n){for(var o=0,r=e.length;r>o;o++)d.call(e,o)&&t.call(n,e[o],o,e)}function i(e,t,n){for(var o=0,r=e.length;r>o;o++)t.call(n,e.charAt(o),o,e)}function s(e,t,n){for(var o in e)d.call(e,o)&&t.call(n,e[o],o,e)}var a=e("is-function");t.exports=o;var u=Object.prototype.toString,d=Object.prototype.hasOwnProperty},{"is-function":6}],9:[function(e,t,n){function o(e){return e.replace(/^\s*|\s*$/g,"")}n=t.exports=o,n.left=function(e){return e.replace(/^\s*/,"")},n.right=function(e){return e.replace(/\s*$/,"")}},{}],10:[function(e,t,n){var o=e("trim"),r=e("for-each"),i=function(e){return"[object Array]"===Object.prototype.toString.call(e)};t.exports=function(e){if(!e)return{};var t={};return r(o(e).split("\n"),function(e){var n=e.indexOf(":"),r=o(e.slice(0,n)).toLowerCase(),s=o(e.slice(n+1));"undefined"==typeof t[r]?t[r]=s:i(t[r])?t[r].push(s):t[r]=[t[r],s]}),t}},{"for-each":8,trim:9}],11:[function(e,t,n){function o(){for(var e={},t=0;t<arguments.length;t++){var n=arguments[t];for(var o in n)r.call(n,o)&&(e[o]=n[o])}return e}t.exports=o;var r=Object.prototype.hasOwnProperty},{}],12:[function(e,t,n){(function(o){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(n,"__esModule",{value:!0});var i="undefined"!=typeof window?window.videojs:"undefined"!=typeof o?o.videojs:null,s=r(i),a=e("./metrics"),u=r(a),d=function(e){(0,u["default"])(this,e)};s["default"].plugin("metrics",d),n["default"]=d,t.exports=n["default"]}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./metrics":1}]},{},[12])(12)});