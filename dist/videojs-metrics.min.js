/*! videojs-metrics - v0.0.0 - 2015-10-22
* Copyright (c) 2015 benjipott; Licensed Apache-2.0 */
!function(a,b){"use strict";b.Metrics=b.Component.extend({init:function(a,c){c.user_id=c.user_id||666,b.Component.call(this,a,c),this.setupTriggers(),this.browserInfo=b.Metrics.getBrowser(),a.ready(function(){b.on(a.mediaPlayer,MediaPlayer.events.STREAM_INITIALIZED,b.bind(this,this.onInitialized)),a.on(MediaPlayer.events.STREAM_SWITCH_STARTED,b.bind(this,this.onInitialized)),a.on(MediaPlayer.events.STREAM_SWITCH_COMPLETED,b.bind(this,this.onInitialized))})}}),b.Metrics.prototype.onInitialized=function(a,b){b&&this.player().error(b);this.player().mediaPlayer.getBitrateInfoListFor("video")},b.Metrics.prototype.options_={option:!0,user_id:"",method:"POST",responseType:"json",timeout:1e3,url:"//stats.afrostream.tv/api/v1/events",trackEvents:["ping","firstplay","ended","dispose","waiting","error","bandwidthIncrease","bandwidthDecrease","dispose"]},b.Metrics.getBrowser=function(){var a,b,c,d,e={},f=null,g=null,h=null,i=null;return a=function(){var a=navigator.userAgent.toLowerCase(),b=/(ie|firefox|chrome|safari|opera)(?:.*version)?(?:[ \/])?([\w.]+)/.exec(a),c=/(mac|win|linux|freebsd|mobile|iphone|ipod|ipad|android|blackberry|j2me|webtv)/.exec(a);a.match(/trident\/7\./)?(f="ie",g=11):b&&b.length>2&&(f=b[1],g=b[2]),c&&c.length>1&&(h=c[1]),i=navigator.oscpu||navigator.appName},b=function(){e.browser=f,e.version=parseInt(g,10)||null,e.os=h,e.osVersion=i},c=function(){"mac"===h&&(h="osx")},d=function(){"safari"===h&&(g=g.substring(0,1))},a(),c(),d(),b(),e},b.Metrics.INTERVAL_PING=6e4,b.Metrics.BASE_KEYS=["user_id","type"],b.Metrics.REQUIRED_KEY={bandwidthIncrease:["video_bitrate","audio_bitrate"],bandwidthDecrease:["video_bitrate","audio_bitrate"],ping:["fqdn"],buffering:[],error:["number","message"],start:["video_bitrate","audio_bitrate","fqdn","os","os_version","web_browser","web_browser_version","resolution_size","flash_version","html5_video","relative_url"],stop:["timeout","frames_dropped"]},b.Metrics.URL_MATCH=/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/gi,b.Metrics.prototype.oldType=null,b.Metrics.prototype.intervalPing=0,b.Metrics.prototype.browserInfo={},b.Metrics.prototype.eventHandler=function(a){var c={type:a.type},d=!1;switch(c.type){case"error":break;case"dispose":case"ended":c.type===this.oldType&&(d=!0),c.type="stop";break;case"firstplay":c.type="start",this.intervalPing=this.setInterval(this.onPing,b.Metrics.INTERVAL_PING);break;case"waiting":c.type="buffering";break;case"bandwidthIncrease":case"bandwidthDecrease":}this.oldType=c.type,d||this.notify(c)},b.Metrics.prototype.onPing=function(){this.player().trigger("ping")},b.Metrics.prototype.setupTriggers=function(){for(var a=this.options().trackEvents.length-1;a>=0;a--)this.player().on(this.options().trackEvents[a],b.bind(this,this.eventHandler))},b.Metrics.pick=function(a,b,c){var d={};return"string"==typeof b&&(b=[b]),Object.keys(a).forEach(function(c){b.indexOf(c)>-1&&(d[c]=a[c])},c),d},b.Metrics.prototype.getRequiredKeys=function(a){return b.Metrics.BASE_KEYS.concat(b.Metrics.REQUIRED_KEY[a]||[])},b.Metrics.prototype.notify=function(a){var c=this.player(),d=b.Metrics.URL_MATCH.exec(c.manifestUrl||c.currentSrc());a.user_id=this.options().user_id,a.fqdn=d[1],a.os=this.browserInfo.os,a.os_version=this.browserInfo.osVersion.toString(),a.web_browser=this.browserInfo.browser,a.web_browser_version=this.browserInfo.version.toString(),a.resolution_size=screen.width+"x"+screen.height,a.flash_version=b.Flash.version().join(","),a.html5_video="Html5"===c.techName,a.relative_url=d[2],a.timeout=!1,a.frames_dropped=0;try{var e=c.techGet("getPlaybackStatistics");a.video_bitrate=e.video.bandwidth||0,a.audio_bitrate=e.audio.bandwidth||0;var f=b.Metrics.pick(a,this.getRequiredKeys(a.type));this.xhr(this.options(),f)}catch(g){b.log(g)}},b.Metrics.prototype.xhr=function(c,d,e){var f,g,h={method:"GET",timeout:45e3};"function"!=typeof e&&(e=function(){}),"object"==typeof c&&(h=b.util.mergeOptions(h,c),c=h.url);var i=a.XMLHttpRequest;"undefined"==typeof i&&(i=function(){try{return new a.ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new a.ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new a.ActiveXObject("Msxml2.XMLHTTP")}catch(d){}throw new Error("This browser does not support XMLHttpRequest.")}),f=new i,f.open(h.method,c),f.url=c,f.requestTime=(new Date).getTime(),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h.responseType&&(f.responseType=h.responseType),h.withCredentials&&(f.withCredentials=!0),h.timeout&&(g=a.setTimeout(function(){4!==f.readyState&&(f.timedout=!0,f.abort())},h.timeout)),f.onreadystatechange=function(){return 4===this.readyState?(a.clearTimeout(g),f.timedout?e.call(this,"timeout",c):this.status>=400||0===this.status?e.call(this,!0,c):(this.response&&(this.responseTime=(new Date).getTime(),this.roundTripTime=this.responseTime-this.requestTime,this.bytesReceived=this.response.byteLength||this.response.length,this.bandwidth=Math.floor(this.bytesReceived/this.roundTripTime*8*1e3)),e.call(this,!1,c))):void 0};var j="";if("object"==typeof d)for(var k in d)j+=(0===j.length?"":"&")+k+"="+encodeURIComponent(d[k]);return f.send(j),f},b.MediaTechController.prototype.getPlaybackStatistics=function(){return{video:{bandwidth:-1},audio:{bandwidth:-1}}},b.options.children.metrics={}}(window,window.videojs);